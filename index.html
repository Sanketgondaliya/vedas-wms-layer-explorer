<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WMS Layer Explorer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/2.3.3/css/dataTables.dataTables.min.css">
    <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.15.1/css/ol.css">
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --accent-color: #1abc9c;
            --light-bg: #f8f9fa;
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        html,
        body {
            padding: 5px 0;
            height: 100%;
            width: 100%;
            margin: 0;
            background-color: #f0f2f5;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
        }

        .container-fluid {
            height: 100%;
        }

        .row {
            height: 100%;
            margin: 0;
        }

        .col-md-5 {
            height: 100%;
            display: flex;
            flex-direction: column;
            padding-right: 10px;
        }

        .col-md-7 {
            height: 100%;
            display: flex;
            flex-direction: column;
            padding-left: 10px;
        }

        /* Server Selection Card */
        .col-md-5 .card:first-child {
            flex: 0 0 auto;
            margin-bottom: 20px;
        }

        /* Available Layers Card */
        .col-md-5 .card:last-child {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .col-md-5 .card:last-child .card-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding: 0;
        }

        .table-container {
            flex: 1;
            overflow: auto;
        }

        /* Map Card */
        .col-md-7 .card:first-child {
            flex: 0 0 auto;
            margin-bottom: 20px;
        }

        /* Bottom Cards Row */
        .col-md-7 .row {
            flex: 1;
            margin: 0;
            overflow: hidden;
        }

        .col-md-7 .row .col-md-6 {
            height: 100%;
            padding: 0 5px;
        }

        .col-md-7 .row .card {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .col-md-7 .row .card .card-body {
            flex: 1;
            overflow: auto;
        }

        /* Card Styling */
        .card {
            box-shadow: var(--card-shadow);
            border: none;
            border-radius: 10px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
        }

        .card-header {
            background: linear-gradient(to right, var(--primary-color), #4a6fa5);
            color: white;
            font-weight: 600;
            border-radius: 10px 10px 0 0 !important;
            padding: 12px 20px;
        }

        .card-header i {
            margin-right: 8px;
        }

        /* Map Styling */
        #map {
            height: 300px;
            width: 100%;
            position: relative;
            border-radius: 8px;
            overflow: hidden;
        }

        .overlay-loader {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            border-radius: 8px;
        }

        /* Button Styling */
        .btn-action {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            margin-right: 0.25rem;
        }

        .btn-primary {
            background: linear-gradient(to right, var(--primary-color), #2980b9);
            border: none;
            transition: all 0.3s;
        }

        .btn-primary:hover {
            background: linear-gradient(to right, #2980b9, var(--primary-color));
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        /* Active Layers Styling */
        .active-layer-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1.25rem;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s;
        }

        .active-layer-item:hover {
            background-color: #f8f9fa;
        }

        .active-layer-item:last-child {
            border-bottom: none;
        }

        /* Legend Styling */
        .legend img {
            max-width: 100%;
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
            padding: 5px;
            background: white;
        }

        .feature-info {
            max-height: 200px;
            overflow-y: auto;
        }

        /* Loading Indicator */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .server-info {
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }

        /* Improved Popup Styling */
        .ol-popup {
            position: absolute;
            background-color: white;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            padding: 0;
            border-radius: 12px;
            border: 1px solid #cccccc;
            bottom: 12px;
            left: -50px;
            min-width: 300px;
            max-height: 350px;
            overflow: hidden;
            z-index: 100;
        }

        .ol-popup-header {
            background: linear-gradient(to right, var(--primary-color), #4a6fa5);
            color: white;
            padding: 12px 15px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ol-popup-content {
            padding: 15px;
            max-height: 250px;
            overflow-y: auto;
        }

        .ol-popup-closer {
            background: none;
            border: none;
            color: white;
            font-weight: bold;
            font-size: 18px;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.2);
            transition: all 0.2s;
            cursor: pointer;
        }

        .ol-popup-closer:hover {
            background-color: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .ol-popup:after,
        .ol-popup:before {
            top: 100%;
            border: solid transparent;
            content: " ";
            height: 0;
            width: 0;
            position: absolute;
            pointer-events: none;
        }

        .ol-popup:after {
            border-top-color: white;
            border-width: 10px;
            left: 48px;
            margin-left: -10px;
        }

        .ol-popup:before {
            border-top-color: #cccccc;
            border-width: 11px;
            left: 48px;
            margin-left: -11px;
        }

        /* Base layer selector */
        .btn-group .btn {
            transition: all 0.2s;
        }

        .btn-group .btn:hover {
            background-color: #e9ecef;
        }

        /* Server selection dropdown */
        .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(52, 152, 219, 0.25);
        }

        /* Table styling */
        .table-hover tbody tr:hover {
            background-color: rgba(52, 152, 219, 0.05);
        }

        /* Badge styling */
        .badge {
            font-size: 0.75em;
            padding: 0.4em 0.6em;
        }

        /* DataTables customization */
        .dataTables_wrapper .dataTables_length,
        .dataTables_wrapper .dataTables_filter,
        .dataTables_wrapper .dataTables_info,
        .dataTables_wrapper .dataTables_paginate {
            margin: 10px;
            padding: 5px;
        }

        .dataTables_wrapper .dataTables_length select {
            border: 1px solid #ced4da;
            border-radius: 0.375rem;
            padding: 0.375rem 2.25rem 0.375rem 0.75rem;
            background-color: #fff;
            margin: 0 5px;
        }

        .dataTables_wrapper .dataTables_filter input {
            border: 1px solid #ced4da;
            border-radius: 0.375rem;
            padding: 0.375rem 0.75rem;
            margin-left: 5px;
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button {
            border: 1px solid transparent;
            padding: 0.375rem 0.75rem;
            border-radius: 0.375rem;
            margin: 0 2px;
            color: #0d6efd !important;
            background-color: transparent;
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button.current,
        .dataTables_wrapper .dataTables_paginate .paginate_button.current:hover {
            color: #fff !important;
            background-color: #0d6efd;
            border-color: #0d6efd;
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
            color: #0a58ca !important;
            background-color: #e9ecef;
            border-color: transparent;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Active layers list styling */
        #activeLayersList {
            max-height: none;
            overflow-y: auto;
            border-radius: 0 0 8px 8px;
        }

        /* Legend styling */
        #legend {
            max-height: none;
            overflow-y: auto;
            padding: 10px;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .col-md-5, .col-md-7 {
                height: auto;
                padding: 0;
            }
            
            .card {
                margin-bottom: 15px;
            }

            #map {
                height: 250px;
            }

            .dataTables_wrapper .dataTables_length,
            .dataTables_wrapper .dataTables_filter {
                margin-bottom: 10px;
            }
            
            .ol-popup {
                min-width: 250px;
                left: -30px;
            }

            .ol-popup-header {
                padding: 10px 12px;
            }

            .ol-popup-closer {
                width: 24px;
                height: 24px;
                font-size: 16px;
            }
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-5">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-server"></i> WMS Server Selection
                    </div>
                    <div class="card-body">
                        <div class="server-select">
                            <label class="form-label fw-bold">Select WMS Server:</label>
                            <select class="form-select form-select-lg mb-3" id="serverSelect">
                                <option value="https://vedas.sac.gov.in/geoserver/vedas_gis/wms">VEDAS GeoServer
                                </option>
                                <option value="https://bhuvan-vec1.nrsc.gov.in/bhuvan/gwc/service/wms">Bhuvan
                                    GeoWebCache</option>
                                <option value="https://vedas.sac.gov.in/leangeo_mapserver/LeanGeo/wms">VEDAS LeanGeo
                                </option>
                                <option value="https://vedas.sac.gov.in/drought_monitoring_wms/wms?">VEDAS Drought
                                    Monitoring</option>
                                <option value="https://vedas.sac.gov.in/gserver/vegetationmonitoring/wms">VEDAS
                                    Vegetation Monitoring</option>
                            </select>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="useCorsProxy" checked>
                            <label class="form-check-label" for="useCorsProxy">
                                Use CORS Proxy (required for GitHub Pages)
                            </label>
                        </div>
                        <button id="fetchLayersBtn" class="btn btn-primary btn-lg w-100">
                            <i class="bi bi-cloud-download"></i> Fetch Available Layers
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-layer-forward"></i> Available Layers</span>
                        <span class="badge bg-primary" id="layerCount">0</span>
                    </div>
                    <div class="card-body p-0">
                        <div class="loading" id="loading">
                            <div class="loading-spinner spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading layer information...</p>
                        </div>
                        <div class="table-container">
                            <table class="table table-hover table-sm" id="layersTable">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th>Title</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="layersTableBody">
                                    <tr>
                                        <td colspan="2" class="text-center py-4">No layers loaded yet</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-7">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-map"></i> Map View
                    </div>
                    <div class="card-body position-relative">
                        <div id="map"></div>
                        <div class="overlay-loader" id="mapLoader" style="display: none;">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Adding layer to map...</p>
                            </div>
                        </div>
                        <div class="mt-3">
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="baseLayer" id="osmLayer" autocomplete="off"
                                    checked>
                                <label class="btn btn-outline-primary" for="osmLayer">OpenStreetMap</label>

                                <input type="radio" class="btn-check" name="baseLayer" id="satelliteLayer"
                                    autocomplete="off">
                                <label class="btn btn-outline-primary" for="satelliteLayer">Satellite</label>

                                <input type="radio" class="btn-check" name="baseLayer" id="terrainLayer"
                                    autocomplete="off">
                                <label class="btn btn-outline-primary" for="terrainLayer">Terrain</label>
                            </div>
                        </div>
                    </div>
                    <!-- Popup -->
                    <div id="popup" class="ol-popup">
                        <div class="ol-popup-header">
                            <span>Feature Information</span>
                            <button id="popup-closer" class="ol-popup-closer" aria-label="Close">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                        <div class="ol-popup-content" id="popup-content"></div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span><i class="bi bi-list-check"></i> Active Layers</span>
                                <span class="badge bg-success" id="activeLayerCount">0</span>
                            </div>
                            <div class="card-body p-0">
                                <ul class="list-group list-group-flush" id="activeLayersList">
                                    <li class="list-group-item text-center py-4">No active layers</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span><i class="bi bi-info-square"></i> Layer Legend</span>
                            </div>
                            <div class="card-body p-0">
                                <div class="legend p-3" id="legend">
                                    <p class="text-muted text-center mb-0">No active layer selected</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/2.3.3/js/dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.15.1/build/ol.js"></script>
    <script>
        // Initialize map
        const map = new ol.Map({
            target: 'map',
            layers: [
                new ol.layer.Tile({
                    source: new ol.source.OSM(),
                    visible: true,
                    name: 'OpenStreetMap'
                }),
                new ol.layer.Tile({
                    source: new ol.source.XYZ({
                        url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                        attributions: '© Esri'
                    }),
                    visible: false,
                    name: 'Satellite'
                }),
                new ol.layer.Tile({
                    source: new ol.source.XYZ({
                        url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Shaded_Relief/MapServer/tile/{z}/{y}/{x}',
                        attributions: '© Esri'
                    }),
                    visible: false,
                    name: 'Terrain'
                })
            ],
            view: new ol.View({
                center: ol.proj.fromLonLat([80.1514, 17.2473]),
                zoom: 5
            })
        });
        
        // Create popup overlay
        const container = document.getElementById('popup');
        const content = document.getElementById('popup-content');
        const closer = document.getElementById('popup-closer');

        const overlay = new ol.Overlay({
            element: container,
            autoPan: {
                animation: {
                    duration: 250,
                },
            },
        });
        map.addOverlay(overlay);

        // Close popup
        closer.onclick = function () {
            overlay.setPosition(undefined);
            closer.blur();
            return false;
        };

        // Store active WMS layers
        const activeLayers = [];

        // Store the parsed XML document globally
        let capabilitiesXmlDoc = null;

        // Store DataTable instance
        let layersDataTable = null;

        // Store the current server URL
        let currentServerUrl = '';

        // CORS proxy function
        function getCorsProxiedUrl(url) {
            const useProxy = document.getElementById('useCorsProxy').checked;
            if (!useProxy) return url;
            
            // Using a public CORS proxy
            return `https://corsproxy.io/?${encodeURIComponent(url)}`;
        }

        // Base layer switcher
        document.querySelectorAll('input[name="baseLayer"]').forEach(radio => {
            radio.addEventListener('change', () => {
                const layers = map.getLayers();
                layers.forEach((layer, index) => {
                    if (index < 3) { // First three layers are base layers
                        layer.setVisible(false);
                    }
                });

                if (radio.id === 'osmLayer') {
                    layers.item(0).setVisible(true);
                } else if (radio.id === 'satelliteLayer') {
                    layers.item(1).setVisible(true);
                } else if (radio.id === 'terrainLayer') {
                    layers.item(2).setVisible(true);
                }
            });
        });

        // Fetch layers from GetCapabilities
        document.getElementById('fetchLayersBtn').addEventListener('click', function () {
            currentServerUrl = document.getElementById('serverSelect').value;
            const capabilitiesUrl = `${currentServerUrl}?service=WMS&request=GetCapabilities&version=1.3.0`;
            const proxiedUrl = getCorsProxiedUrl(capabilitiesUrl);

            // Show loading indicator
            document.getElementById('loading').style.display = 'block';
            // Clear previous results
            document.getElementById('layersTableBody').innerHTML = '';

            fetch(proxiedUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                    }
                    return response.text();
                })
                .then(xmlText => {
                    // Hide loading indicator
                    document.getElementById('loading').style.display = 'none';

                    // Parse XML
                    const parser = new DOMParser();
                    capabilitiesXmlDoc = parser.parseFromString(xmlText, "text/xml");

                    // Check for XML errors
                    const parseError = capabilitiesXmlDoc.getElementsByTagName("parsererror");
                    if (parseError.length > 0) {
                        throw new Error("Failed to parse XML response");
                    }

                    // Extract server info
                    const service = capabilitiesXmlDoc.getElementsByTagName('Service')[0];
                    if (!service) {
                        throw new Error("No Service information found in response");
                    }

                    const serviceTitle = service.getElementsByTagName('Title')[0]?.textContent || 'Unknown Service';
                    const serviceAbstract = service.getElementsByTagName('Abstract')[0]?.textContent || 'No description available';

                    // Extract layers
                    const layerElements = capabilitiesXmlDoc.getElementsByTagName("Layer");
                    const layersTableBody = document.getElementById('layersTableBody');
                    layersTableBody.innerHTML = ''; // Clear previous results

                    let layerCount = 0;

                    for (let i = 0; i < layerElements.length; i++) {
                        const nameElem = layerElements[i].getElementsByTagName("Name")[0];
                        const titleElem = layerElements[i].getElementsByTagName("Title")[0];

                        if (nameElem && titleElem) {
                            const layerName = nameElem.textContent;
                            const layerTitle = titleElem.textContent;

                            // Skip the root layer which often has the service title
                            if (layerTitle === serviceTitle) continue;

                            const row = layersTableBody.insertRow();
                            const cellTitle = row.insertCell(0);
                            const cellActions = row.insertCell(1);

                            cellTitle.textContent = layerTitle;

                            // Add action buttons
                            cellActions.innerHTML = `
                                <button class="btn btn-sm btn-outline-primary btn-action zoom-layer" data-layer="${layerName}" title="Zoom to Layer">
                                    <i class="bi bi-zoom-in"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-success btn-action add-layer" 
                                        data-layer="${layerName}" 
                                        data-title="${layerTitle}"
                                        title="Add Layer to Map">
                                    <i class="bi bi-plus-circle"></i>
                                </button>
                            `;

                            layerCount++;
                        }
                    }

                    document.getElementById('layerCount').textContent = layerCount;

                    if (layerCount === 0) {
                        layersTableBody.innerHTML = `
                            <tr>
                                <td colspan="2" class="text-center py-4">
                                    No layers found in the GetCapabilities response
                                </td>
                            </tr>
                        `;
                    }

                    // Initialize or reinitialize DataTable
                    if (layersDataTable) {
                        layersDataTable.destroy();
                    }

                    layersDataTable = $('#layersTable').DataTable({
                        pageLength: 5,
                        lengthMenu: [5, 10, 25, 50],
                        ordering: true,
                        searching: true,
                        responsive: true,
                        autoWidth: false,
                        columns: [
                            { title: "Title" },
                            { title: "Actions", orderable: false, searchable: false }
                        ]
                    });

                    // Use event delegation for dynamically created elements
                    $('#layersTableBody').on('click', '.zoom-layer', function () {
                        const layerName = $(this).data('layer');
                        zoomToLayer(layerName);
                    });

                    $('#layersTableBody').on('click', '.add-layer', function () {
                        const layerName = $(this).data('layer');
                        const layerTitle = $(this).data('title');
                        addWmsLayer(currentServerUrl, layerName, layerTitle);
                    });
                })
                .catch(error => {
                    document.getElementById('loading').style.display = 'none';
                    console.error('Error fetching GetCapabilities:', error);

                    document.getElementById('layersTableBody').innerHTML = `
                        <tr>
                            <td colspan="2" class="text-center py-4 text-danger">
                                Error: ${error.message}
                            </td>
                        </tr>
                    `;
                });
        });

        // Function to zoom to a specific layer's extent
        function zoomToLayer(layerName) {
            if (!capabilitiesXmlDoc) {
                alert('No capabilities data available. Please fetch layers first.');
                return;
            }

            // Find the layer element in the XML
            const layerElements = capabilitiesXmlDoc.getElementsByTagName("Layer");
            let targetLayer = null;

            for (let i = 0; i < layerElements.length; i++) {
                const nameElem = layerElements[i].getElementsByTagName("Name")[0];
                if (nameElem && nameElem.textContent === layerName) {
                    targetLayer = layerElements[i];
                    break;
                }
            }

            if (!targetLayer) {
                alert('Layer information not found');
                return;
            }

            // Try to get bounding box in CRS:84 (standard lon/lat)
            let bboxElem = targetLayer.getElementsByTagName("BoundingBox")[0];
            if (!bboxElem) {
                alert('No bounding box information available for this layer');
                return;
            }

            // Check if we have a CRS:84 bounding box
            let crs84Bbox = null;
            for (let i = 0; i < targetLayer.getElementsByTagName("BoundingBox").length; i++) {
                const bbox = targetLayer.getElementsByTagName("BoundingBox")[i];
                if (bbox.getAttribute('CRS') === 'CRS:84') {
                    crs84Bbox = bbox;
                    break;
                }
            }

            // If no CRS:84, use the first available bounding box
            if (!crs84Bbox) {
                crs84Bbox = bboxElem;
            }

            const minx = parseFloat(crs84Bbox.getAttribute('minx'));
            const miny = parseFloat(crs84Bbox.getAttribute('miny'));
            const maxx = parseFloat(crs84Bbox.getAttribute('maxx'));
            const maxy = parseFloat(crs84Bbox.getAttribute('maxy'));

            // Convert to map projection (assuming map is using EPSG:3857)
            const bottomLeft = ol.proj.fromLonLat([minx, miny]);
            const topRight = ol.proj.fromLonLat([maxx, maxy]);

            // Calculate extent
            const extent = [
                bottomLeft[0],
                bottomLeft[1],
                topRight[0],
                topRight[1]
            ];

            // Zoom to extent with padding
            map.getView().fit(extent, {
                padding: [50, 50, 50, 50], // Add some padding
                duration: 1000 // Animation duration in ms
            });
        }

        // Function to add WMS layer to map
        function addWmsLayer(serverUrl, layerName, layerTitle) {
            // Check if layer is already added
            if (activeLayers.some(layer => layer.get('name') === layerName)) {
                alert('Layer is already added to the map');
                return;
            }

            // Show loading indicator
            document.getElementById('mapLoader').style.display = 'flex';

            // Create WMS layer
            const wmsLayer = new ol.layer.Tile({
                source: new ol.source.TileWMS({
                    url: serverUrl,
                    params: {
                        'LAYERS': layerName,
                        'TILED': true
                    },
                    serverType: 'geoserver',
                    transition: 0
                }),
                visible: true,
                name: layerName,
                title: layerTitle
            });

            // Add layer to map
            map.addLayer(wmsLayer);
            activeLayers.push(wmsLayer);

            // Hide loading indicator when layer is loaded
            wmsLayer.getSource().on('tileloadend', function () {
                document.getElementById('mapLoader').style.display = 'none';
            });

            // Also hide loader after a timeout as a fallback
            setTimeout(() => {
                document.getElementById('mapLoader').style.display = 'none';
            }, 5000);

            // Update active layers list
            updateActiveLayersList();

            // Update legend
            updateLegend(serverUrl, layerName);
        }

        // Function to update active layers list with zoom buttons
        function updateActiveLayersList() {
            const activeLayersList = document.getElementById('activeLayersList');
            activeLayersList.innerHTML = '';

            if (activeLayers.length === 0) {
                activeLayersList.innerHTML = '<li class="list-group-item text-center py-4">No active layers</li>';
                document.getElementById('activeLayerCount').textContent = '0';
                return;
            }

            document.getElementById('activeLayerCount').textContent = activeLayers.length;

            activeLayers.forEach((layer, index) => {
                const li = document.createElement('li');
                li.className = 'list-group-item active-layer-item';
                li.innerHTML = `
                    <div>
                        <strong>${layer.get('title')}</strong>
                        <br>
                        <small class="text-muted">${layer.get('name')}</small>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-info toggle-layer" data-index="${index}" title="Toggle Visibility">
                            <i class="bi ${layer.getVisible() ? 'bi-eye' : 'bi-eye-slash'}"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-primary zoom-active-layer" data-layer="${layer.get('name')}" title="Zoom to Layer">
                            <i class="bi bi-zoom-in"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger remove-layer" data-index="${index}" title="Remove Layer">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                `;
                activeLayersList.appendChild(li);
            });

            // Add event listeners for toggle, zoom and remove buttons
            document.querySelectorAll('.toggle-layer').forEach(btn => {
                btn.addEventListener('click', function () {
                    const index = parseInt(this.getAttribute('data-index'));
                    const layer = activeLayers[index];
                    layer.setVisible(!layer.getVisible());

                    // Update button icon
                    const icon = this.querySelector('i');
                    icon.className = layer.getVisible() ? 'bi bi-eye' : 'bi bi-eye-slash';
                    this.classList.toggle('btn-outline-secondary', !layer.getVisible());
                });
            });

            // Add event listeners for zoom buttons in active layers
            document.querySelectorAll('.zoom-active-layer').forEach(btn => {
                btn.addEventListener('click', function () {
                    const layerName = this.getAttribute('data-layer');
                    zoomToLayer(layerName);
                });
            });

            document.querySelectorAll('.remove-layer').forEach(btn => {
                btn.addEventListener('click', function () {
                    const index = parseInt(this.getAttribute('data-index'));
                    const layer = activeLayers[index];
                    map.removeLayer(layer);
                    activeLayers.splice(index, 1);
                    updateActiveLayersList();

                    // Clear legend if no layers are active
                    if (activeLayers.length === 0) {
                        document.getElementById('legend').innerHTML = '<p class="text-muted text-center mb-0">No active layer selected</p>';
                    }
                });
            });
        }

        // Update legend for a layer
        function updateLegend(serverUrl, layerName) {
            const legendUrl = `${serverUrl}?REQUEST=GetLegendGraphic&VERSION=1.0.0&FORMAT=image/png&LAYER=${layerName}`;
            const proxiedLegendUrl = getCorsProxiedUrl(legendUrl);
            
            document.getElementById('legend').innerHTML = `
                <strong>Legend for ${layerName}:</strong><br>
                <img src="${proxiedLegendUrl}" alt="${layerName} Legend" style="max-width: 100%">
            `;
        }

        // Feature info on map click
        map.on('singleclick', function (evt) {
            const view = map.getView();
            const viewResolution = view.getResolution();

            // Check all active WMS layers for feature info
            const featureInfoPromises = activeLayers.map(layer => {
                if (!layer.getVisible()) return Promise.resolve(null);

                const source = layer.getSource();
                if (!source || !(source instanceof ol.source.TileWMS)) return Promise.resolve(null);

                const url = source.getFeatureInfoUrl(
                    evt.coordinate,
                    viewResolution,
                    view.getProjection(),
                    { 'INFO_FORMAT': 'application/json' }
                );

                if (!url) return Promise.resolve(null);
                
                const proxiedUrl = getCorsProxiedUrl(url);

                return fetch(proxiedUrl)
                    .then(response => response.json())
                    .then(json => {
                        if (json.features && json.features.length > 0) {
                            return {
                                layer: layer.get('title'),
                                features: json.features
                            };
                        }
                        return null;
                    })
                    .catch(error => {
                        console.error('Error fetching feature info:', error);
                        return null;
                    });
            });

            // Process all promises
            Promise.all(featureInfoPromises).then(results => {
                const validResults = results.filter(result => result !== null);

                if (validResults.length === 0) {
                    document.getElementById('featureInfo').innerHTML = '<p class="text-muted text-center mb-0">No feature information found at this location</p>';
                    return;
                }

                let featureInfoHtml = '';
                validResults.forEach(result => {
                    featureInfoHtml += `<h6>${result.layer}</h6>`;

                    result.features.forEach((feature, index) => {
                        featureInfoHtml += `<div class="mb-3"><strong>Feature ${index + 1}:</strong><table class="table table-sm table-bordered">`;

                        for (const key in feature.properties) {
                            if (feature.properties.hasOwnProperty(key)) {
                                featureInfoHtml += `<tr><td>${key}</td><td>${feature.properties[key]}</td></tr>`;
                            }
                        }

                        featureInfoHtml += '</table></div>';
                    });
                });

                if (featureInfoHtml) {
                    content.innerHTML = featureInfoHtml;
                    overlay.setPosition(evt.coordinate);
                } else {
                    overlay.setPosition(undefined);
                }

            });
        });
    </script>
</body>

</html>
